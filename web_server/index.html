<!DOCTYPE html>
<html>
    <head>
		<script type="text/javascript" src="static/gamepad.js"></script>
        <script type="text/javascript" src="static/socket.io.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        <title>Xbox Server</title>

        Xbox Controller Server
        </br>
        </br>
        (Press F12)
    </head>

    <body>
        <script type="text/javascript" charset="utf-8">5
            $(document).ready(function() {
                namespace = '/test';
                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
                const gamepad = new Gamepad();  //for controller
                steering_angle = 90;    //default value for steering
                motor_angle = 90;       //default value for motor

                //map values between controller and servos
                function mapValue(val, low1, high1, low2, high2) {
                    newValue = low2 + (high2 - low2) * (val - low1) / (high1 - low1)
                    return newValue;
                }

                //--------------------------------------------------------
                //web sockets
                socket.on('connect', function() {
                    console.log("connected");
                    steering_angle = 90;
                    motor_angle = 90;
                    socket.emit('steering_val', steering_angle);
                    socket.emit('motor_val', motor_angle);
                });

                socket.on('disconnect', function() {
                    steering_angle = 90;
                    motor_angle = 90;
                    socket.emit('steering_val', steering_angle);
                    socket.emit('motor_val', motor_angle);
                });

                //--------------------------------------------------------

                //controller connect
                gamepad.on('connect', e => {
                    console.log(`controller ${e.index} connected!`);
                });

                //controller disconnect
                gamepad.on('disconnect', e => {
                    console.log(`controller ${e.index} disconnected!`);
                });

                //hold left stick
                gamepad.on('hold', 'stick_axis_left', e => {
                    stick_lr_val = (`${e.value}`.split(',')[0]);
                    current_stick_value = mapValue(stick_lr_val, -1, 1, 180, 0)
                    if(current_stick_value.toFixed(0) != steering_angle) {
                        steering_angle = current_stick_value.toFixed(0);
                        console.log('New steering angle: ' + steering_angle);
                        socket.emit('steering_event', steering_angle);
                    }
                });

                //release left stick
                gamepad.on('release', 'stick_axis_left', () => {
                    steering_angle = 90;
                    console.log('New steering angle: ' + steering_angle.toFixed(0));
                    socket.emit('steering_event', steering_angle.toFixed(0));
                });

                //hold left shoulder button
                gamepad.on('hold', 'shoulder_bottom_left', e => {
                    current_left_shoulder_value = mapValue(`${e.value.toFixed(2)}`, 0, 1, 90, 0)
                    if((current_left_shoulder_value.toFixed(0)) != motor_angle){
                        motor_angle = current_left_shoulder_value.toFixed(0);
                        console.log('New motor angle: ' + motor_angle);
                        socket.emit('motor_event', motor_angle);
                    }
                });

                //release left shoulder button
                gamepad.on('release', 'shoulder_bottom_left', () => {
                    motor_angle = 90;
                    console.log('New motor angle: ' + motor_angle);
                    socket.emit('motor_event', motor_angle);
                });

                //hold right shoulder button
                gamepad.on('hold', 'shoulder_bottom_right', e => {
                    current_right_shoulder_value = mapValue(`${e.value.toFixed(2)}`, 0, 1, 90, 180)
                    if((current_right_shoulder_value.toFixed(0)) != motor_angle){
                        motor_angle = current_right_shoulder_value.toFixed(0);
                        console.log('New motor angle: ' + motor_angle);
                        socket.emit('motor_event', motor_angle);
                    }
                });

                //release right shoulder button
                gamepad.on('release', 'shoulder_bottom_right', () => {
                    motor_angle = 90;
                    console.log('New motor angle: ' + motor_angle);
                    socket.emit('motor_event', motor_angle);
                });
            });
        </script>
    </body>
</html>